<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Sequencial de Professor</title>
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Estilos básicos */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="file"], .select2-container { width: 100% !important; padding: 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .obrigatorio::after { content: " *"; color: red; }
        
        /* Estilos para Alertas */
        .alerta { padding: 12px; border-radius: 4px; margin-bottom: 15px; display: none; font-weight: bold; }
        .alerta-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alerta-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alerta-info { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        
        /* Estilos dos Botões */
        .botoes-acao button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px; }
        #btnCadastrarOutro { background-color: #28a745; color: white; }
        #btnFinalizar { background-color: #dc3545; color: white; }
        #btnMudarEscola { background-color: #ffc107; color: black; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Cadastro Sequencial de Professor</h1>
        
        <div id="alertaGeral" class="alerta alerta-info"></div>

        <div id="secaoEscola">
            <h2>1. Selecione a Escola</h2>
            <div class="form-group">
                <label for="escola_id" class="obrigatorio">Escola (Digite para pesquisar):</label>
                <select id="escola_id" style="width: 100%">
                    <option value="">Pesquise aqui a unidade...</option>
                </select>
            </div>
            <button id="btnIniciarCadastro" disabled>Iniciar Cadastros para esta Escola</button>
        </div>

        <div id="secaoCadastro" style="display: none;">
            <h2>2. Cadastro de Pessoa</h2>
            <p>Cadastrando na escola: <strong id="escolaNomeDisplay"></strong></p>
            
            <form id="formCadastro" enctype="multipart/form-data">
                
                <div class="form-group">
                    <label for="nome" class="obrigatorio">Nome Completo:</label>
                    <input type="text" id="nome" name="nome" required>
                </div>

                <div class="form-group">
                    <label for="cpf" class="obrigatorio">CPF (11 dígitos, apenas números):</label>
                    <input type="text" id="cpf" name="cpf" pattern="\d{11}" title="O CPF deve conter exatamente 11 dígitos numéricos." required>
                </div>

                <div class="form-group">
                    <label for="foto" class="obrigatorio">Foto para Crachá (Obrigatório):</label>
                    <input type="file" id="foto" name="foto" accept="image/*" required>
                    <small>A foto será renomeada no servidor usando o CPF informado acima.</small>
                </div>
                
                <div class="botoes-acao">
                    <button type="submit" id="btnCadastrarOutro">Cadastrar e Adicionar Outro</button>
                    <button type="button" id="btnFinalizar">Finalizar Cadastros</button>
                </div>
            </form>
            <button type="button" id="btnMudarEscola">Mudar de Escola</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // Variáveis globais para armazenar o contexto
        let idEscolaSelecionada = null;
        let nomeEscolaSelecionada = "";

        $(document).ready(function() {
            const API_ESCOLA_URL = '/api/escolas'; 

            // --- FUNÇÕES GERAIS ---
            
            function exibirAlerta(tipo, mensagem) {
                const alerta = $('#alertaGeral');
                alerta.removeClass('alerta-success alerta-error alerta-info').addClass(`alerta-${tipo}`);
                alerta.text(mensagem).fadeIn();
                if (tipo !== 'error') {
                     alerta.delay(4000).fadeOut();
                }
            }
            
            // Função para resetar toda a aplicação (Volta à Fase 1)
            function resetarTudo() {
                exibirAlerta('info', 'Processo de cadastro finalizado. Escolha uma nova escola para recomeçar.');
                
                $('#formCadastro')[0].reset();
                $('#escola_id').val(null).trigger('change');
                $('#btnIniciarCadastro').prop('disabled', true);
                idEscolaSelecionada = null;
                nomeEscolaSelecionada = "";
                
                $('#secaoCadastro').slideUp();
                $('#secaoEscola').slideDown();
            }

            // --- FASE 1: LÓGICA DE ESCOLHA DA ESCOLA ---

            $('#escola_id').select2({
                placeholder: "Digite para pesquisar a escola...",
                minimumInputLength: 3, 
                language: "pt-BR",
                ajax: {
                    url: API_ESCOLA_URL, 
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return { busca: params.term };
                    },
                    processResults: function (data) {
                        return { results: data.results }; 
                    },
                    cache: true
                }
            }).on('change', function() {
                // Ativa o botão de iniciar quando uma escola é selecionada
                const selectedId = $(this).val();
                if (selectedId) {
                    $('#btnIniciarCadastro').prop('disabled', false);
                } else {
                    $('#btnIniciarCadastro').prop('disabled', true);
                }
            });

            // Ação ao clicar em "Iniciar Cadastros"
            $('#btnIniciarCadastro').on('click', function() {
                idEscolaSelecionada = $('#escola_id').val();
                // Pega o nome da escola do texto selecionado
                nomeEscolaSelecionada = $('#escola_id option:selected').text(); 

                if (idEscolaSelecionada && nomeEscolaSelecionada && nomeEscolaSelecionada !== 'Pesquise aqui a unidade...') {
                    $('#escolaNomeDisplay').text(nomeEscolaSelecionada);
                    
                    $('#secaoEscola').slideUp();
                    $('#secaoCadastro').slideDown(function() {
                        $('#nome').focus();
                    });
                    
                    exibirAlerta('info', `Cadastro iniciado para a escola: ${nomeEscolaSelecionada}.`);
                } else {
                    exibirAlerta('error', 'Por favor, selecione uma escola válida.');
                }
            });
            
            // --- FASE 2: CADASTRO SEQUENCIAL (AJAX) ---

            $('#formCadastro').on('submit', function(e) {
                e.preventDefault(); 
                
                const formData = new FormData(this);
                // Adiciona o ID e o Nome da Escola (fixo) para envio ao Backend
                formData.append('escola_id', idEscolaSelecionada); 
                formData.append('nome_escola', nomeEscolaSelecionada); 
                
                $('.botoes-acao button').prop('disabled', true);
                exibirAlerta('info', 'Processando cadastro, por favor, aguarde...');
                
                fetch('/cadastro', { 
                    method: 'POST',
                    body: formData 
                })
                .then(response => response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || 'Erro desconhecido no servidor.');
                    }
                    return data;
                }))
                .then(data => {
                    // Feedback de Sucesso Incluindo o nome da Escola e da Pessoa
                    exibirAlerta('success', `✅ Sucesso! ${data.nome} cadastrado(a) na escola ${data.nome_escola}.`);
                    
                    // Limpeza rápida dos campos (Nome, CPF e Foto)
                    $('#formCadastro')[0].reset(); 
                    $('#nome').focus(); 
                    
                    $('.botoes-acao button').prop('disabled', false);
                })
                .catch(error => {
                    console.error('Erro de submissão:', error);
                    exibirAlerta('error', `❌ ${error.message}`);
                    $('.botoes-acao button').prop('disabled', false);
                });
            });

            // Ação: Botão Finalizar e Mudar de Escola (Volta para a tela de escolha da escola)
            $('#btnFinalizar, #btnMudarEscola').on('click', resetarTudo);
        });
    </script>
</body>
</html>